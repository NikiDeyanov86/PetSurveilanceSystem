<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name='copyright' content=''>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
	<title>{% block title %}{% endblock %}</title>

    <!-- Stylesheets -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/base_stylesheet.css">

    <!-- Make favicon -->
    <link rel="icon" type="image/png" href="#">

    <!-- JavaScript -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <!-- Additional styles and scripts will go here -->
	{% block head %}

	{% endblock %}

</head>

<body>

    <script>
        /*
        navigator
            .mediaDevices
            .getUserMedia({audio: true})
            .then(stream => { handlerFunction(stream) });

        function handlerFunction(stream) {
            rec = new MediaRecorder(stream);
            rec.ondataavailable = e => {
                audioChunks.push(e.data);
                if (rec.state == "inactive") {
                    let blob = new Blob(audioChunks, {type: 'audio/mpeg-3'});
                    sendData(blob);
                }
            }
        }

        function sendData(data) {
            var form = new FormData();
            form.append('file', data, 'data.mp3');
            form.append('title', 'data.mp3');
            //Chrome inspector shows that the post data includes a file and a title.
            $.ajax({
                type: 'POST',
                url: '/save-record',
                data: form,
                cache: false,
                processData: false,
                contentType: false
            }).done(function(data) {
                console.log(data);
            });
        }

        startRecording.onclick = e => {
            console.log('Recording are started..');
            startRecording.disabled = true;
            stopRecording.disabled = false;
            audioChunks = [];
            rec.start();
        };

        stopRecording.onclick = e => {
            console.log("Recording are stopped.");
            startRecording.disabled = false;
            stopRecording.disabled = true;
            rec.stop();
        };*/

        $(document).ready(function() {
            setInterval("check_vis()",10000); // call every 10 seconds
        });


        function check_vis() {
        $.ajax({
            url: '/check_status',
            success: function (data) {
                 // console.log(data);

                 if(data === "not_visible") {
                     window.location.replace("http://petbot.ddns.net/manual_mode")
                 }
                 else if(data === "visible") {
                     window.location.replace("http://petbot.ddns.net/automated_mode")
                 }
            }
        });
        }
/*
        $(function() {
              $('button#take_photo').on('click', function(e) {
                e.preventDefault()
                $.getJSON('/take_photo',
                    function(data) {
                  //do nothing
                });
                //return false;
              });
        });
*/
    </script>

    <div class="main">
        <div class="content">
            <nav class="navbar navbar-light bg-light">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">PetSurveillanceSystem</span>
                    <h5>Welcome {{ name }}!</h5>
                    <a class="nav-link active" aria-current="page" href="/logout">Log out</a>
                </div>
            </nav>
            <div class="stream_holder">
                <!-- Stream container will go here -->
                <img src="{{ url_for('video_feed') }}">
                <div class="take_photo_holder">
                    <button id="take_photo" class='btn btn-default'>Take photo</button>
                </div>
            </div>
            <div class="mode">
                <div class="mode_holder">
                    <div class="auto">
                        <a href="/automated_mode" id="auto_switch"> AUTO </a>
                    </div>
                </div>
                <div class="mode_holder">
                    <div class="manual">
                        <a href="/manual_mode" id="manual_switch"> MANUAL </a>
                    </div>
                </div>
            </div>
            <!--
            <div id="status">

            </div>

            <div class="voice_recorder">
                <button id="startRecording">Start recording</button>
                <button id="stopRecording" disabled>Stop recording</button>
            </div>
            -->
            <div class="controls">
                <!-- Content will go here -->
                {% block content %}
                {% endblock %}
            </div>
            <div class="alerts">
                {% with messages = get_flashed_messages() %}
                        {% if messages %}
                            <div class="alert alert-primary alert-dismissible fade show" role="alert">
                                <strong>{{ messages[0] }}</strong>
                                <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endif %}
                    {% endwith %}
            </div>
        </div>
    </div>
</body>
</html>
